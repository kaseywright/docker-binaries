#!/usr/bin/env sh
#set -x #echo on # DEBUG
set -e

IMAGE_TAG_VERSION=${IMAGE_TAG_VERSION:=latest}
DOCKER_USER=""

# Auto-detect container runtime with user preference override
detect_container_runtime() {
  # Check if user has explicitly set a preference
  if [ -n "$DB_CONTAINER_RUNTIME" ]; then
    echo "$DB_CONTAINER_RUNTIME"
    return 0
  fi
  
  # Auto-detect available runtimes
  if command -v podman >/dev/null 2>&1; then
    echo "podman"
  elif command -v docker >/dev/null 2>&1; then
    echo "docker"
  else
    echo "Error: Neither docker nor podman found in PATH" >&2
    exit 1
  fi
}

CONTAINER_RUNTIME=$(detect_container_runtime)

# "$(uname)" == "Darwin"
# "$(expr substr $(uname -s) 1 5)" == "Linux"
# "$(expr substr $(uname -s) 1 10)" == "MINGW32_NT"
if [ "$(uname)" = "Darwin" ]
then
  if [ "$FORCED_PORTS" = "" ]
  then
    DOCKER_NETWORKING="\
    -p 80:80 \
    -p 3000:3000 \
    -p 3306:3306 \
    -p 3307:3307 \
    -p 3308:3308 \
    -p 8000:8000 \
    -p 8001:8001 \
    -p 8002:8002 \
    -p 8080:8080 \
    -p 9000:9000"
  else
    DOCKER_NETWORKING="-p ${FORCED_PORTS}:${FORCED_PORTS}"
  fi
elif [ "$(expr substr $(uname -s) 1 5)" = "Linux" ]
then
  echo " >>> Executed in container at '$(uname -s)' host machine using $CONTAINER_RUNTIME"
  DOCKER_USER="--user=$(id -u)"
  DOCKER_NETWORKING=--net=host
elif [ "$(expr substr $(uname -s) 1 10)" = "MINGW32_NT" ]
then
  echo "# Todo: Support for WIN 32bit"
elif [ "$(expr substr $(uname -s) 1 10)" = "MINGW64_NT" ]
then
  echo "# Todo: Support for WIN 64bit"
else
   echo "None of the condition met"
fi

if [ "$TTY" = "" ]
  then
    TTY="-i"
  else
    TTY="-it"
fi

$CONTAINER_RUNTIME run \
 $TTY \
 -v "${HOME}:${HOME}" \
 -v "${HOME}":/root \
 -v "${PWD}:${PWD}" \
 -v /tmp/:/tmp/ \
 -w "${PWD}" \
 $DOCKER_NETWORKING \
 $DOCKER_USER \
 --sig-proxy=true \
 --pid=host \
 --rm \
 "${IMAGE_NAME}:${IMAGE_TAG_VERSION}" \
 "${COMMAND_TO_EXECUTE}" \
 "$@"
